openapi: 3.0.3
info:
  title: Temporal Alpha Engine API
  version: "0.1.0"
  description: >
    Temporal Alpha Engine (TAE) provides directional alpha signals, confidence, regime classification,
    and risk gating across multiple horizons. This API is designed to be simple, stable, and embeddable.
servers:
  - url: https://api.temporalalpha.example.com
    description: Production
  - url: https://sandbox.temporalalpha.example.com
    description: Sandbox
security:
  - ApiKeyAuth: []
tags:
  - name: Signals
    description: Retrieve predictive signals for symbols and horizons.
  - name: Subscriptions
    description: Webhook subscriptions for signal events and state changes.
  - name: Meta
    description: Health and metadata endpoints.

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key

  parameters:
    SymbolParam:
      name: symbol
      in: query
      required: true
      schema:
        type: string
        example: BTC-USD
      description: Instrument symbol (e.g., BTC-USD, ETH-USD, SPY).
    HorizonParam:
      name: horizon
      in: query
      required: true
      schema:
        $ref: "#/components/schemas/Horizon"
      description: Forecast horizon identifier.
    IncludeOptionalParam:
      name: include
      in: query
      required: false
      schema:
        type: array
        items:
          type: string
          enum: [expected_move_bps, vol_forecast, reasons]
      style: form
      explode: true
      description: Optional fields to include in response.
    AsOfParam:
      name: asof_ts
      in: query
      required: false
      schema:
        type: string
        format: date-time
      description: Optional as-of timestamp for backtesting/replay (if enabled for your plan).

  responses:
    Unauthorized:
      description: Missing/invalid API key.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    RateLimited:
      description: Rate limit exceeded.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    NotFound:
      description: Resource not found.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"

  schemas:
    Horizon:
      type: string
      enum: [H1, H2, H3]
      description: >
        Horizon identifiers. Common mapping:
        H1=~5-15 minutes, H2=~1-4 hours, H3=~1-5 days (implementation-defined).
      example: H2

    Regime:
      type: string
      enum: [trend, mean_revert, chop, shock, transition]
      example: trend

    RiskGate:
      type: string
      enum: [allow, reduce, block]
      example: allow

    Signal:
      type: object
      required: [symbol, horizon, asof_ts, expiry_ts, alpha, confidence, regime, risk_gate, version]
      properties:
        symbol:
          type: string
          example: BTC-USD
        horizon:
          $ref: "#/components/schemas/Horizon"
        asof_ts:
          type: string
          format: date-time
          example: "2026-01-04T10:15:00Z"
          description: Timestamp the signal was computed for.
        expiry_ts:
          type: string
          format: date-time
          example: "2026-01-04T14:15:00Z"
          description: Timestamp after which the signal should be considered stale.
        alpha:
          type: number
          format: double
          minimum: -1
          maximum: 1
          example: 0.63
          description: Directional alpha in [-1, +1]. Negative=bearish, positive=bullish.
        confidence:
          type: number
          format: double
          minimum: 0
          maximum: 1
          example: 0.78
          description: Calibrated confidence in [0, 1].
        regime:
          $ref: "#/components/schemas/Regime"
        risk_gate:
          $ref: "#/components/schemas/RiskGate"
        expected_move_bps:
          type: integer
          example: 42
          nullable: true
          description: Optional expected move in basis points over the horizon.
        vol_forecast:
          type: number
          format: double
          example: 0.021
          nullable: true
          description: Optional volatility forecast (unit/scale implementation-defined).
        reasons:
          type: array
          items:
            type: string
          example: ["vol_spike", "model_disagreement"]
          nullable: true
          description: Optional high-level reason codes (may be restricted by plan).
        version:
          type: string
          example: tae-0.1.3
          description: Model/package version that generated this signal.

    BatchSignalRequest:
      type: object
      required: [symbols, horizons]
      properties:
        symbols:
          type: array
          minItems: 1
          maxItems: 200
          items:
            type: string
          example: ["BTC-USD", "ETH-USD", "SPY"]
        horizons:
          type: array
          minItems: 1
          maxItems: 3
          items:
            $ref: "#/components/schemas/Horizon"
          example: ["H1", "H2", "H3"]
        include:
          type: array
          items:
            type: string
            enum: [expected_move_bps, vol_forecast, reasons]
          description: Optional fields to include in each signal response.
        asof_ts:
          type: string
          format: date-time
          nullable: true
          description: Optional as-of timestamp for replay/backtest (if enabled).

    BatchSignalResponse:
      type: object
      required: [signals]
      properties:
        signals:
          type: array
          items:
            $ref: "#/components/schemas/Signal"

    SubscriptionEventType:
      type: string
      enum:
        - alpha_threshold_crossed
        - risk_gate_changed
        - regime_changed
        - signal_published
      example: risk_gate_changed

    Comparator:
      type: string
      enum: [gt, gte, lt, lte, eq]
      example: gte

    ThresholdRule:
      type: object
      required: [field, comparator, value]
      properties:
        field:
          type: string
          enum: [alpha, confidence]
          example: alpha
        comparator:
          $ref: "#/components/schemas/Comparator"
        value:
          type: number
          format: double
          example: 0.6

    SubscriptionCreateRequest:
      type: object
      required: [name, callback_url, symbols, horizons, event_types]
      properties:
        name:
          type: string
          example: "TAE Webhook - Core"
        callback_url:
          type: string
          format: uri
          example: "https://client.example.com/webhooks/tae"
        secret:
          type: string
          nullable: true
          example: "supersecretsharedkey"
          description: Optional shared secret for HMAC signature verification.
        symbols:
          type: array
          minItems: 1
          maxItems: 200
          items:
            type: string
          example: ["BTC-USD", "ETH-USD"]
        horizons:
          type: array
          minItems: 1
          maxItems: 3
          items:
            $ref: "#/components/schemas/Horizon"
          example: ["H2"]
        event_types:
          type: array
          minItems: 1
          items:
            $ref: "#/components/schemas/SubscriptionEventType"
          example: ["risk_gate_changed", "alpha_threshold_crossed"]
        rules:
          type: array
          items:
            $ref: "#/components/schemas/ThresholdRule"
          nullable: true
          description: Optional filtering rules (e.g., only fire when alpha >= 0.6).
        enabled:
          type: boolean
          default: true

    Subscription:
      type: object
      required: [id, name, callback_url, symbols, horizons, event_types, enabled, created_ts]
      properties:
        id:
          type: string
          example: sub_01HZY0R0V7K9Q2XQ8JZ2T2P1A1
        name:
          type: string
        callback_url:
          type: string
          format: uri
        symbols:
          type: array
          items:
            type: string
        horizons:
          type: array
          items:
            $ref: "#/components/schemas/Horizon"
        event_types:
          type: array
          items:
            $ref: "#/components/schemas/SubscriptionEventType"
        rules:
          type: array
          items:
            $ref: "#/components/schemas/ThresholdRule"
          nullable: true
        enabled:
          type: boolean
        created_ts:
          type: string
          format: date-time
        updated_ts:
          type: string
          format: date-time
          nullable: true

    WebhookEnvelope:
      type: object
      required: [event_type, subscription_id, sent_ts, data]
      properties:
        event_type:
          $ref: "#/components/schemas/SubscriptionEventType"
        subscription_id:
          type: string
          example: sub_01HZY0R0V7K9Q2XQ8JZ2T2P1A1
        sent_ts:
          type: string
          format: date-time
          example: "2026-01-04T10:16:02Z"
        data:
          oneOf:
            - $ref: "#/components/schemas/Signal"
            - type: object
              description: Event-specific payload.

    Health:
      type: object
      required: [status, ts, version]
      properties:
        status:
          type: string
          enum: [ok]
          example: ok
        ts:
          type: string
          format: date-time
          example: "2026-01-04T10:15:00Z"
        version:
          type: string
          example: api-0.1.0

    Error:
      type: object
      required: [error, message]
      properties:
        error:
          type: string
          example: unauthorized
        message:
          type: string
          example: Invalid API key.
        request_id:
          type: string
          example: req_01HZY0S3GQ7H9M2F4Y0YVQ8VY2

paths:
  /v1/health:
    get:
      tags: [Meta]
      summary: Health check
      security: []  # public
      responses:
        "200":
          description: API is healthy.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Health"

  /v1/signal/latest:
    get:
      tags: [Signals]
      summary: Get the latest signal for a symbol and horizon
      parameters:
        - $ref: "#/components/parameters/SymbolParam"
        - $ref: "#/components/parameters/HorizonParam"
        - $ref: "#/components/parameters/IncludeOptionalParam"
        - $ref: "#/components/parameters/AsOfParam"
      responses:
        "200":
          description: Latest signal.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Signal"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "429":
          $ref: "#/components/responses/RateLimited"

  /v1/signal/batch:
    post:
      tags: [Signals]
      summary: Get signals for multiple symbols and horizons
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BatchSignalRequest"
      responses:
        "200":
          description: Batch signals response.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BatchSignalResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "429":
          $ref: "#/components/responses/RateLimited"

  /v1/subscriptions:
    post:
      tags: [Subscriptions]
      summary: Create a webhook subscription
      description: >
        Creates a webhook subscription for signal events (thresholds, regime changes, risk gate changes).
        If a secret is provided, the server will sign requests (e.g., HMAC) for verification.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SubscriptionCreateRequest"
      responses:
        "201":
          description: Subscription created.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Subscription"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "429":
          $ref: "#/components/responses/RateLimited"

    get:
      tags: [Subscriptions]
      summary: List webhook subscriptions
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
        - name: cursor
          in: query
          required: false
          schema:
            type: string
          description: Pagination cursor (opaque).
      responses:
        "200":
          description: A list of subscriptions.
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/Subscription"
                  next_cursor:
                    type: string
                    nullable: true
        "401":
          $ref: "#/components/responses/Unauthorized"
        "429":
          $ref: "#/components/responses/RateLimited"

  /v1/subscriptions/{subscription_id}:
    get:
      tags: [Subscriptions]
      summary: Get a webhook subscription
      parameters:
        - name: subscription_id
          in: path
          required: true
          schema:
            type: string
          example: sub_01HZY0R0V7K9Q2XQ8JZ2T2P1A1
      responses:
        "200":
          description: Subscription details.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Subscription"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "429":
          $ref: "#/components/responses/RateLimited"

    delete:
      tags: [Subscriptions]
      summary: Delete a webhook subscription
      parameters:
        - name: subscription_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Deleted successfully.
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "429":
          $ref: "#/components/responses/RateLimited"

  /v1/webhook/test:
    post:
      tags: [Subscriptions]
      summary: Send a test webhook event (sandbox/enterprise)
      description: >
        Emits a test webhook payload to a subscription's callback_url. This is typically enabled only in sandbox
        or enterprise environments.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [subscription_id, event_type]
              properties:
                subscription_id:
                  type: string
                event_type:
                  $ref: "#/components/schemas/SubscriptionEventType"
                data:
                  nullable: true
                  oneOf:
                    - $ref: "#/components/schemas/Signal"
                    - type: object
      responses:
        "200":
          description: Test webhook queued/sent.
          content:
            application/json:
              schema:
                type: object
                required: [status]
                properties:
                  status:
                    type: string
                    example: sent
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "429":
          $ref: "#/components/responses/RateLimited"
